function daysInMonth(o){var t=(new Date).getFullYear();return new Date(t,o,0).getDate()}function getWeekDayName(o,t){var i=(new Date).getFullYear();return["вс","пн","вт","ср","чт","пт","сб"][new Date(i,t-1,o).getDay()]}function getRandomColor(){return"hsl("+360*Math.random()+","+(25+70*Math.random())+"%,"+(50+10*Math.random())+"%)"}function getCookie(o){const t=`; ${document.cookie}`.split(`; ${o}=`);if(2===t.length)return t.pop().split(";").shift()}function formatPhoneNumber(o){var t=(""+o).replace(/\D/g,"").match(/^(380|)?(\d{2})(\d{3})(\d{2})(\d{2})$/);return t?[t[1]?"+380 ":"","(",t[2],") ",t[3]," ",t[4]," ",t[5]].join(""):o}function rgb2hsl(o){tmp_s=o.substring(4,o.length-1),rgb_vals=tmp_s.split(","),r=rgb_vals[0],g=rgb_vals[1],b=rgb_vals[2],r/=255,g/=255,b/=255;var t,i,e=Math.max(r,g,b),n=Math.min(r,g,b),a=(e+n)/2;if(e==n)t=i=0;else{var s=e-n;switch(i=a>.5?s/(2-e-n):s/(e+n),e){case r:t=(g-b)/s+(g<b?6:0);break;case g:t=(b-r)/s+2;break;case b:t=(r-g)/s+4}t/=6}return[Math.floor(360*t),Math.floor(100*i),Math.floor(100*a)]}$.fn.multiline=function(o){return this.text(o),this.html(this.html().replace(/\n/g,"<br />")),this};let days_amount=153,rooms_amount=45,ch=30,cw=60;var tmp_d=1,tmp_m=5,rooms_list_block_w=100;function createBookingDiv(o,t,i,e,n){var a=0;if(o+i>days_amount)return alert("ERR3100: Невозможно создать бронирование для даты, которая выходит за границы сезона."),!1;var s=132+o*cw,d=(room_num_list.indexOf(t)+1)*ch+22,l=cw*Math.round(i);return"d"==n.charAt(0)&&(s-=30,l+=30),"n"==n.charAt(1)?l+=28:l-=2,$(".schedule-booked").each(function(){if(d==$(this).position().top){var o=$(this).position().left,t=o+$(this).width();(s+l>=o&&s+l<=t||s<=o&&t<=s+l||s>=o&&s<=t)&&(alert("ERR3102: Невозможно создать бронирование на период, который пересекает другое бронирование."),a=1)}}),1!=a&&($cell_div_bg=$("<div />").appendTo("#booking-boxes"),$cell_div_bg.css("left",s),$cell_div_bg.css("top",d),$cell_div_bg.css("width",l),$cell_div_bg.attr("class","schedule-booked"),$cell_div_bg.attr("id","bgsch-id-"+e),$cell_div_b=$("<div />").appendTo($cell_div_bg),$cell_div_b.attr("class","schedule-booked-box"),$cell_div_b.css("background-color",getRandomColor()),$cell_div_b.attr("id","bsch-id-"+e),$cell_div_b)}function highlight_booking_div(o){var t=$("#bsch-id-"+o).css("background-color");t=rgb2hsl(t),$("body,html").animate({scrollTop:$("#bgsch-id-"+o).offset().top-$(window).height()/2+15,scrollLeft:$("#bgsch-id-"+o).offset().left-$(window).width()/2+parseInt($("#bgsch-id-"+o).css("width"))/2},300),setTimeout(function(){$("#bsch-id-"+o).css("background-color","hsl("+t[0]+","+t[1]+"%,95%)"),setTimeout(function(){$("#bsch-id-"+o).css("background-color","hsl("+t[0]+","+t[1]+"%,"+t[2]+"%)")},750)},300)}function close_details_popup(){$("#shaded-screen").remove(),$("body").css("overflow",""),$("#booking-details-popup").toggle(),$("#booking-inp-name").val(""),$("#booking-inp-phone").val(""),$("#booking-inp-room").val(""),$("#booking-inp-doa").val(""),$("#booking-inp-dod").val(""),$("#booking-inp-mod").val(""),$("#booking-inp-info").val(""),$("#booking-inp-doa-timetype").val("2"),$("#booking-inp-dod-timetype").val("4"),$("#booking-details-save-btn").attr("class",""),$("#booking-details-delete-btn").attr("class",""),$("#booking-details-delete-btn").removeAttr("hidden")}function close_search_popup(){$("#shaded-screen").remove(),$("body").css("overflow",""),$("#booking-search-popup").toggle()}function close_dailyreport_popup(){$("#shaded-screen").remove(),$("body").css("overflow",""),$("#booking-dailyreport-popup").toggle()}function update_dailyreport(o){if($("#dailyreport-results").empty(),-1==o)return!1;$.getJSON("action",{listbydate:o,uid:getCookie("id"),auth:getCookie("token")},function(o){"ok"==`${o.status}`?o.amount>0?$.each(o.res,function(){var o=$("<li />");o.attr("id","dailyrepres-id-"+this.id),o.text(this.name);var t="";parseInt($("#dailyreport-inp-req").val())==parseInt(this.first_day_index)?(t+="Въезд ","d"==this.timetype.charAt(0)?t+="в первой половине дня":"n"==this.timetype.charAt(0)&&(t+="во второй половине дня")):(t+="Выезд ","d"==this.timetype.charAt(1)?t+="в первой половине дня":"n"==this.timetype.charAt(1)&&(t+="во второй половине дня")),o.append($("<p />").text("Комната: "+this.room+"\nНомер телефона: "+this.phone+"\n"+t)),$("#dailyreport-results").append(o)}):alert("В выбранный день нет записей о въезде или выезде."):alert("ERR0019 Ошибка запроса.")})}$(window).on("scroll",function(){var o=$(this).scrollTop();$("#rooms-list").css("top",-o);var t=$(this).scrollLeft();$("#days-list").css("left",100-t)});var day_i_arr=[],room_num_list=[39,1,2,3,4,5,6,7,8,35,36,37,38,43,44,45,25,27,28,29,30,32,34,40,41,42,26,31,33,17,18,19,20,21,22,23,24,9,10,11,12,13,14,15,16];function fill_dod_select(o){$("#booking-inp-dod").empty();for(let t=o+1;t<days_amount;t++)$("#booking-inp-dod").append($("<option />").val(t-o).text(day_i_arr[t]))}$(document).ready(function(){var o=1,t=5;for(let i=0;i<days_amount;i++)day_i_arr.push(("0"+o).slice(-2)+"."+("0"+t).slice(-2)),++o>daysInMonth(t)&&(o=1,t++);var i=$("#rooms-list");i.css("width",rooms_list_block_w),i.css("height",ch*(rooms_amount+1)),$("#days-list").css("width",cw*days_amount);for(let o=1;o<=rooms_amount;o++){$cell_div_room=$("<div />").appendTo("#rooms-list"),$cell_div_room.attr("class","schedule-cell"),$cell_div_room.css("top",o*ch+20),$cell_div_room.attr("id","room-index-"+room_num_list[o-1]);var e=$("<p />").appendTo($cell_div_room);1==o?e.text("Коттедж "+room_num_list[o-1]):e.text(room_num_list[o-1])}for(let o=0;o<=rooms_amount;o++)for(let t=0;t<days_amount;t++){var n;if(0!=o)(n=$("<div />").appendTo("#schedule-body")).attr("class","schedule-cell"),n.css("top",o*ch+20),n.css("left",t*cw+rooms_list_block_w),n.data("room",room_num_list[o-1]),n.data("day",t);else(n=$("<div />").appendTo("#days-list")).attr("class","schedule-cell"),n.attr("id","day-index-"+t),n.css("left",t*cw),(e=$("<p />").appendTo(n)).text(("0"+tmp_d).slice(-2)+"."+("0"+tmp_m).slice(-2)),$("<p />").appendTo(n).text(getWeekDayName(tmp_d,tmp_m)),++tmp_d>daysInMonth(tmp_m)&&(tmp_d=1,tmp_m++)}$("#schedule-body .schedule-cell").mouseenter(function(){var o=$(this).data("room"),t=$(this).data("day");$("#day-index-"+t).css("background-color","#bbb"),$("#room-index-"+o).css("background-color","#bbb")}),$("#schedule-body .schedule-cell").mouseleave(function(){var o=$(this).data("room"),t=$(this).data("day");$("#day-index-"+t).css("background-color",""),$("#room-index-"+o).css("background-color","")}),$("#schedule-body .schedule-cell").click(function(){var o=$(this).data("room"),t=$(this).data("day");$("<div />").appendTo("body").attr("id","shaded-screen"),$("body").css("overflow","hidden"),$("#booking-details-delete-btn").attr("hidden",!0),$("#booking-details-popup").toggle(),$("#booking-inp-room").val(o),$("#booking-inp-doa").val(t),fill_dod_select(t),$("#booking-inp-mod").val(1),$("#booking-inp-dod").val(1),$("#booking-inp-phone").val("+380"),$("#booking-inp-info").val("")});var a=$('<optgroup label="Коттедж" />'),s=$('<optgroup label="Двухместный люкс" />'),d=$('<optgroup label="Четырёхместный люкс" />'),l=$('<optgroup label="Шестиместный люкс" />'),r=$('<optgroup label="Двухместный эконом" />'),p=$('<optgroup label="Четырёхместный эконом" />');for(let o=0;o<rooms_amount;o++)0==o?a.append($("<option />").val(room_num_list[o]).text(room_num_list[o])):o>=1&&o<16?s.append($("<option />").val(room_num_list[o]).text(room_num_list[o])):o>=16&&o<26?d.append($("<option />").val(room_num_list[o]).text(room_num_list[o])):o>=26&&o<29?l.append($("<option />").val(room_num_list[o]).text(room_num_list[o])):o>=29&&o<37?r.append($("<option />").val(room_num_list[o]).text(room_num_list[o])):o>=37&&o<45&&p.append($("<option />").val(room_num_list[o]).text(room_num_list[o]));$("#booking-inp-room").append(a),$("#booking-inp-room").append(s),$("#booking-inp-room").append(d),$("#booking-inp-room").append(l),$("#booking-inp-room").append(r),$("#booking-inp-room").append(p);var c=1,u=5;for(let o=0;o<days_amount;o++)$("#booking-inp-doa").append($("<option />").val(o).text(("0"+c).slice(-2)+"."+("0"+u).slice(-2))),++c>daysInMonth(u)&&(c=1,u++);for(let o=0;o<days_amount;o++)$("#dailyreport-inp-req").append($("<option />").val(o).text(day_i_arr[o]));$("#booking-inp-doa").on("change",function(){$("#booking-inp-mod").attr("max",days_amount-parseInt(this.value)),fill_dod_select(parseInt(this.value)),$("#booking-inp-dod").val($("#booking-inp-mod").val())}),$.getJSON("action",{list:"",uid:getCookie("id"),auth:getCookie("token")},function(o){"ok"==`${o.status}`?$.each(o.res,function(){createBookingDiv(this.first_day_index,this.room,this.duration,this.id,this.timetype)}):alert("ERR0000 Ошибка запроса.")}),$("#booking-boxes").on("click",".schedule-booked-box",function(){$(this).attr("id").startsWith("bsch-id-")&&function(o){$("<div />").appendTo("body").attr("id","shaded-screen"),$("body").css("overflow","hidden"),$("#booking-details-popup").toggle(),$.getJSON("action",{get:"",id:o,uid:getCookie("id"),auth:getCookie("token")},function(t){"ok"==`${t.status}`?($("#booking-inp-name").val(t.name),$("#booking-inp-phone").val(t.phone),$("#booking-inp-room").val(t.room),$("#booking-inp-doa").val(t.first_day_index),$("#booking-inp-mod").val(t.duration),fill_dod_select(t.first_day_index),$("#booking-inp-dod").val(t.duration),$("#booking-inp-info").val(t.info),$("#booking-inp-doa-timetype").val("d"==t.timetype.charAt(0)?"0":"2"),$("#booking-inp-dod-timetype").val("d"==t.timetype.charAt(1)?"4":"3"),$("#booking-details-save-btn").attr("class","save-btn-id-"+o),$("#booking-details-delete-btn").attr("class","delete-btn-id-"+o)):alert("ERR0001 Ошибка запроса.")})}($(this).attr("id").split("-")[2])}),$("#booking-details-delete-btn").on("click",function(){if(confirm("Вы подтверждаете удаление этой записи?")){var o=$(this).attr("class").split("-")[3];$.getJSON("action",{delete:"",id:o,uid:getCookie("id"),auth:getCookie("token")},function(t){"ok"==`${t.status}`?(close_details_popup(),alert("Запись была удалена"),$("#bgsch-id-"+o).remove()):alert("ERR0002 Ошибка запроса.")})}}),$("#booking-details-save-btn").on("click",function(){if(void 0===$(this).attr("class")||""==$(this).attr("class"))$.getJSON("action",{create:"",name:$("#booking-inp-name").val(),phone:$("#booking-inp-phone").val(),room:$("#booking-inp-room").val(),doa:$("#booking-inp-doa").val(),duration:$("#booking-inp-mod").val(),info:$("#booking-inp-info").val(),timetype:parseInt($("#booking-inp-doa-timetype").val())+parseInt($("#booking-inp-dod-timetype").val())-3,uid:getCookie("id"),auth:getCookie("token")},function(o){"ok"==`${o.status}`?(close_details_popup(),$.getJSON("action",{get:"",id:o.id,uid:getCookie("id"),auth:getCookie("token")},function(o){"ok"==`${o.status}`?createBookingDiv(o.first_day_index,o.room,o.duration,o.id,o.timetype):alert("ERR0000 Ошибка запроса.")})):alert("ERR0010 Ошибка запроса: "+`${o.err_desc}`)});else if($(this).attr("class").startsWith("save-btn-id-")){var o=$(this).attr("class").split("-")[3];$.getJSON("action",{update:"",id:o,name:$("#booking-inp-name").val(),phone:$("#booking-inp-phone").val(),room:$("#booking-inp-room").val(),doa:$("#booking-inp-doa").val(),duration:$("#booking-inp-mod").val(),info:$("#booking-inp-info").val(),timetype:parseInt($("#booking-inp-doa-timetype").val())+parseInt($("#booking-inp-dod-timetype").val())-3,uid:getCookie("id"),auth:getCookie("token")},function(t){"ok"==`${t.status}`?(close_details_popup(),alert("Запись обновлена."),$("#bgsch-id-"+o).remove(),$.getJSON("action",{get:"",id:o,uid:getCookie("id"),auth:getCookie("token")},function(t){"ok"==`${t.status}`?createBookingDiv(t.first_day_index,t.room,t.duration,o,t.timetype):alert("ERR0000 Ошибка запроса.")})):alert("ERR0001 Ошибка запроса: "+`${t.err_desc}`)})}}),$("#booking-boxes").on("mouseover",".schedule-booked",function(){var o=$(".schedule-booked-box",this).attr("id").split("-")[2],t=$(".schedule-booked-box",this).css("background-color");t=rgb2hsl(t);var i=$(this);$.getJSON("action",{get:"",id:o,uid:getCookie("id"),auth:getCookie("token")},function(o){"ok"==`${o.status}`?($("#booking-tooltip").multiline("Имя: "+o.name+"\nНомер телефона: "+formatPhoneNumber(o.phone)+"\n\nДополнительная информация:\n"+(null==o.info||""==o.info?"-":o.info)),i.position().top>=1e3&&$("#booking-tooltip").css("top",i.position().top-$("#booking-tooltip").height()-10),i.position().left>=8900&&$("#booking-tooltip").css("left",i.position().left-$("#booking-tooltip").width())):alert("ERR0001 Ошибка запроса.")}),$(this).position().top<1e3&&$("#booking-tooltip").css("top",$(this).position().top+28),$(this).position().left<8900&&$("#booking-tooltip").css("left",$(this).position().left+10),$("#booking-tooltip").css("opacity","1"),$("#booking-tooltip").css("z-index","5000"),$("#booking-tooltip").css("background-color","hsl("+t[0]+","+t[1]+"%,"+(t[2]+30)+"%)")}),$("#booking-boxes").on("mouseleave",".schedule-booked",function(){$("#booking-tooltip").css("opacity","0"),$("#booking-tooltip").css("z-index","-1"),$("#booking-tooltip").text("Загрузка данных...")}),$("#search-button").on("click",function(){$("<div />").appendTo("body").attr("id","shaded-screen"),$("body").css("overflow","hidden"),$("#booking-search-popup").toggle()}),$("#dailyreport-button").on("click",function(){$("<div />").appendTo("body").attr("id","shaded-screen"),$("body").css("overflow","hidden"),$("#booking-dailyreport-popup").toggle();var o=new Date;f_date=("0"+o.getDate()).slice(-2)+"."+("0"+(o.getMonth()+1)).slice(-2),tmp_dr_for_di=day_i_arr.indexOf(f_date),$("#dailyreport-inp-req").val(tmp_dr_for_di),update_dailyreport(tmp_dr_for_di)}),$("#dailyreport-inp-req").on("input",function(){update_dailyreport(parseInt($(this).val()))}),$(".side-button").on("mouseover",function(){$("#side-button-tooltip").css("opacity","1"),$("#side-button-tooltip").css("z-index","7500"),$("#side-button-tooltip").css("top",$(this).position().top+5);var o=$(this).attr("id");"dailyreport-button"==o?$("#side-button-tooltip").text("Ежедневный отчёт"):"search-button"==o&&$("#side-button-tooltip").text("Поиск записи")}),$(".side-button").on("mouseleave",function(){$("#side-button-tooltip").css("opacity","0"),$("#side-button-tooltip").css("z-index","-1"),$("#side-button-tooltip").text("")}),$("#search-inp-req").on("input",function(){$("#search-results-amount").removeAttr("hidden"),$("#search-results").removeAttr("hidden"),$.getJSON("action",{search:"",q:$(this).val(),uid:getCookie("id"),auth:getCookie("token")},function(o){"ok"==`${o.status}`?($("#search-results-amount").text("Найдено результатов: "+o.amount),$("#search-results").empty(),$.each(o.res,function(){var o=$("<li />");o.attr("id","searchres-id-"+this.id),o.text(this.name),o.append($("<p />").text("Комната: "+this.room+"\nНомер телефона: "+this.phone+"\nВремя пребывания: "+day_i_arr[this.first_day_index]+" - "+day_i_arr[this.first_day_index+this.duration])),$("#search-results").append(o)})):alert("ERR0009 Ошибка запроса.")})}),$("#booking-inp-mod").on("input",function(){$("#booking-inp-dod").val(this.value)}),$("#booking-inp-dod").on("change",function(){$("#booking-inp-mod").val(this.value)}),$("#search-results").on("click","li",function(){$(this).attr("id").startsWith("searchres-id-")&&(close_search_popup(),highlight_booking_div($(this).attr("id").split("-")[2]))}),$("#dailyreport-results").on("click","li",function(){$(this).attr("id").startsWith("dailyrepres-id-")&&(close_dailyreport_popup(),highlight_booking_div($(this).attr("id").split("-")[2]))})}),window.onload=function(){var o=new Date;f_date=("0"+o.getDate()).slice(-2)+"."+("0"+(o.getMonth()+1)).slice(-2),curr_d_i=day_i_arr.indexOf(f_date),-1!=curr_d_i&&setTimeout(window.scrollTo,10,Math.max(0,curr_d_i*cw-5*cw),window.scrollY)};